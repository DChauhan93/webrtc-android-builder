name: Build WebRTC Android AAR (M92 â€“ Final Corrected)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      WEBRTC_BRANCH: branch-heads/4606
      ANDROID_NDK_VERSION: r21e
      DEPOT_TOOLS_UPDATE: 0
      GCLIENT_HTTP_RETRY: 5
      GIT_HTTP_LOW_SPEED_LIMIT: 0
      GIT_HTTP_LOW_SPEED_TIME: 999999
      VPYTHON_BYPASS: manually managed python not supported by chrome operations

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------------------------
      # FREE DISK SPACE (CRITICAL)
      # -------------------------------------------------
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/lib/jvm
          sudo apt-get clean
          sudo apt-get autoremove -y
          df -h

      # -------------------------------------------------
      # PREPARE /mnt FOR LARGE BUILDS
      # -------------------------------------------------
      - name: Prepare /mnt
        run: |
          sudo mkdir -p /mnt/git-tmp /mnt/build
          sudo chmod -R 777 /mnt
          git config --global core.tmpdir /mnt/git-tmp

      # -------------------------------------------------
      # PYTHON SETUP
      # python3 -> for fetch + build_aar
      # python2 -> for gclient / landmines
      # -------------------------------------------------
      - name: Install Python 2
        run: |
          sudo apt-get update
          sudo apt-get install -y python2
          /usr/bin/python2 --version

      - name: Setup Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      # -------------------------------------------------
      # SYSTEM DEPENDENCIES (MINIMAL)
      # -------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get install -y \
            git curl unzip perl \
            clang-14 ninja-build pkg-config

      - name: Force clang-14
        run: |
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-14 100

      # -------------------------------------------------
      # ANDROID NDK r21e
      # -------------------------------------------------
      - name: Install Android NDK r21e
        run: |
          cd /mnt
          curl -LO https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
          unzip -q android-ndk-r21e-linux-x86_64.zip
          echo "ANDROID_NDK_HOME=/mnt/android-ndk-r21e" >> $GITHUB_ENV
          echo "/mnt/android-ndk-r21e" >> $GITHUB_PATH

      # -------------------------------------------------
      # depot_tools (MUST BE FIRST IN PATH)
      # -------------------------------------------------
      - name: Fetch depot_tools
        run: |
          cd /mnt
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "/mnt/depot_tools" >> $GITHUB_PATH

      # -------------------------------------------------
      # FETCH WEBRTC M92 (RUN FETCH WITH PYTHON 3)
      # -------------------------------------------------
      - name: Fetch WebRTC M92
        run: |
          cd /mnt
          python3 /mnt/depot_tools/fetch.py --nohooks webrtc_android
          cd src
          git checkout $WEBRTC_BRANCH

      # -------------------------------------------------
      # HARDEN GIT (googlesource stability)
      # -------------------------------------------------
      - name: Harden git
        run: |
          git config --global http.version HTTP/1.1
          git config --global fetch.parallel 1
          git config --global pack.threads 1
          git config --global core.deltaBaseCacheLimit 2g

      # -------------------------------------------------
      # CLEAN PARTIAL STATE (DEFENSIVE)
      # -------------------------------------------------
      - name: Cleanup partial gclient state
        run: |
          rm -rf /mnt/src/third_party/ffmpeg
          rm -rf /mnt/src/third_party/boringssl
          rm -rf /mnt/src/.gclient_entries
          rm -rf /mnt/src/.gclient_previous_sync_commits

      # -------------------------------------------------
      # gclient sync (EXPLICIT PYTHON 2)
      # -------------------------------------------------
      - name: Sync WebRTC dependencies (Python 2)
        run: |
          cd /mnt/src
          PYTHON=/usr/bin/python2 gclient sync \
            --force \
            --no-history \
            --with_branch_heads \
            --with_tags \
            --jobs=1 || \
          PYTHON=/usr/bin/python2 gclient sync \
            --force \
            --no-history \
            --with_branch_heads \
            --with_tags \
            --jobs=1

      # -------------------------------------------------
      # JAVA API PATCH (GenerateKeyFrame)
      # -------------------------------------------------
      - name: Patch Java RtpSender
        run: |
          perl -0777 -i -pe 's|(private RtpSender\\(long nativeRtpSender\\)\\s*\\{\\s*this\\.nativeRtpSender = nativeRtpSender;\\s*\\})|$1\n\n  public void generateKeyFrame() {\n    nativeGenerateKeyFrame(nativeRtpSender);\n  }\n\n  private static native void nativeGenerateKeyFrame(long nativeRtpSender);\n|s unless /generateKeyFrame\\s*\\(/' \
          /mnt/src/sdk/android/api/org/webrtc/RtpSender.java

      # -------------------------------------------------
      # JNI PATCH
      # -------------------------------------------------
      - name: Patch JNI RtpSender
        run: |
          perl -0777 -i -pe 's|(#include "sdk/android/src/jni/pc/rtp_sender_jni.h"\\n)|$1\nJNI_FUNCTION_DECLARATION(void, RtpSender_nativeGenerateKeyFrame, JNIEnv*, jclass, jlong native_rtp_sender) {\n  auto* sender = reinterpret_cast<webrtc::RtpSenderInterface*>(native_rtp_sender);\n  sender->GenerateKeyFrame();\n}\n\n|s unless /nativeGenerateKeyFrame/' \
          /mnt/src/sdk/android/src/jni/pc/rtp_sender.cc

      # -------------------------------------------------
      # BUILD AAR (PYTHON 3)
      # -------------------------------------------------
      - name: Build WebRTC Android AAR
        run: |
          cd /mnt/src
          python3 tools_webrtc/android/build_aar.py \
            --arch armeabi-v7a \
            --output /mnt/out \
            --extra-gn-args='
              is_debug=false
              rtc_use_h264=true
              rtc_enable_protobuf=false
              use_rtti=true
              use_custom_libcxx=false
            '

      # -------------------------------------------------
      # UPLOAD ARTIFACT
      # -------------------------------------------------
      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-m92-force-keyframe-aar
          path: /mnt/out/*.aar
