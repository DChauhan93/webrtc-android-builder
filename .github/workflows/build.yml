name: Build WebRTC Android AAR (M92 â€“ Final Stable)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      WEBRTC_BRANCH: branch-heads/4606
      ANDROID_NDK_VERSION: r21e
      DEPOT_TOOLS_UPDATE: 0
      GCLIENT_HTTP_RETRY: 5
      GIT_HTTP_LOW_SPEED_LIMIT: 0
      GIT_HTTP_LOW_SPEED_TIME: 999999
      VPYTHON_BYPASS: manually managed python not supported by chrome operations

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 1. FREE DISK SPACE (MUST BE FIRST)
      # -------------------------------------------------
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/lib/jvm
          sudo apt-get clean
          sudo apt-get autoremove -y
          df -h

      # -------------------------------------------------
      # 2. PREPARE /mnt FOR LARGE OPERATIONS
      # -------------------------------------------------
      - name: Prepare /mnt
        run: |
          sudo mkdir -p /mnt/git-tmp /mnt/build
          sudo chmod -R 777 /mnt
          git config --global core.tmpdir /mnt/git-tmp

      # -------------------------------------------------
      # 3. INSTALL PYTHON 2.7 AND PYTHON 3.10
      # -------------------------------------------------
      - name: Install Python 2.7 and Python 3.10
        run: |
          sudo apt-get update
          sudo apt-get install -y python2 python3.10
          /usr/bin/python2 --version
          python3.10 --version

      # -------------------------------------------------
      # 4. SYSTEM DEPENDENCIES
      # -------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get install -y \
            git curl unzip perl \
            clang-14 ninja-build pkg-config

      - name: Force clang-14
        run: |
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-14 100

      # -------------------------------------------------
      # 5. ANDROID NDK r21e
      # -------------------------------------------------
      - name: Install Android NDK r21e
        run: |
          cd /mnt
          curl -LO https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
          unzip -q android-ndk-r21e-linux-x86_64.zip
          echo "ANDROID_NDK_HOME=/mnt/android-ndk-r21e" >> $GITHUB_ENV
          echo "/mnt/android-ndk-r21e" >> $GITHUB_PATH

      # -------------------------------------------------
      # 6. depot_tools (FIRST IN PATH)
      # -------------------------------------------------
      - name: Fetch depot_tools
        run: |
          cd /mnt
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "/mnt/depot_tools" >> $GITHUB_PATH

      # -------------------------------------------------
      # 7. FETCH WEBRTC WITH PYTHON 3.10 ONLY
      # -------------------------------------------------
      - name: Fetch WebRTC M92 (python3.10)
        run: |
          cd /mnt
          python3.10 /mnt/depot_tools/fetch.py --nohooks webrtc_android
          cd src
          git checkout $WEBRTC_BRANCH

      # -------------------------------------------------
      # 8. HARDEN GIT (NETWORK STABILITY)
      # -------------------------------------------------
      - name: Harden git
        run: |
          git config --global http.version HTTP/1.1
          git config --global fetch.parallel 1
          git config --global pack.threads 1
          git config --global core.deltaBaseCacheLimit 2g

      # -------------------------------------------------
      # 9. FORCE python -> python2 FOR gclient
      # -------------------------------------------------
      - name: Force python to Python 2 for gclient
        run: |
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 100
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.10 10
          python --version

      # -------------------------------------------------
      # 10. CLEAN PARTIAL STATE (DEFENSIVE)
      # -------------------------------------------------
      - name: Cleanup partial gclient state
        run: |
          rm -rf /mnt/src/third_party/ffmpeg
          rm -rf /mnt/src/third_party/boringssl
          rm -rf /mnt/src/.gclient_entries
          rm -rf /mnt/src/.gclient_previous_sync_commits

      # -------------------------------------------------
      # 11. gclient sync (RUNS UNDER PYTHON 2)
      # -------------------------------------------------
      - name: Sync WebRTC dependencies (python2)
        run: |
          cd /mnt/src
          gclient sync \
            --force \
            --no-history \
            --with_branch_heads \
            --with_tags \
            --jobs=1 || \
          gclient sync \
            --force \
            --no-history \
            --with_branch_heads \
            --with_tags \
            --jobs=1

      # -------------------------------------------------
      # 12. JAVA API PATCH (GenerateKeyFrame)
      # -------------------------------------------------
      - name: Patch Java RtpSender
        run: |
          perl -0777 -i -pe 's|(private RtpSender\\(long nativeRtpSender\\)\\s*\\{\\s*this\\.nativeRtpSender = nativeRtpSender;\\s*\\})|$1\n\n  public void generateKeyFrame() {\n    nativeGenerateKeyFrame(nativeRtpSender);\n  }\n\n  private static native void nativeGenerateKeyFrame(long nativeRtpSender);\n|s unless /generateKeyFrame\\s*\\(/' \
          /mnt/src/sdk/android/api/org/webrtc/RtpSender.java

      # -------------------------------------------------
      # 13. JNI PATCH
      # -------------------------------------------------
      - name: Patch JNI RtpSender
        run: |
          perl -0777 -i -pe 's|(#include "sdk/android/src/jni/pc/rtp_sender_jni.h"\\n)|$1\nJNI_FUNCTION_DECLARATION(void, RtpSender_nativeGenerateKeyFrame, JNIEnv*, jclass, jlong native_rtp_sender) {\n  auto* sender = reinterpret_cast<webrtc::RtpSenderInterface*>(native_rtp_sender);\n  sender->GenerateKeyFrame();\n}\n\n|s unless /nativeGenerateKeyFrame/' \
          /mnt/src/sdk/android/src/jni/pc/rtp_sender.cc

      # -------------------------------------------------
      # 14. BUILD AAR (EXPLICIT PYTHON 3.10)
      # -------------------------------------------------
      - name: Build WebRTC Android AAR
        run: |
          cd /mnt/src
          python3.10 tools_webrtc/android/build_aar.py \
            --arch armeabi-v7a \
            --output /mnt/out \
            --extra-gn-args='
              is_debug=false
              rtc_use_h264=true
              rtc_enable_protobuf=false
              use_rtti=true
              use_custom_libcxx=false
            '

      # -------------------------------------------------
      # 15. UPLOAD ARTIFACT
      # -------------------------------------------------
      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-m92-force-keyframe-aar
          path: /mnt/out/*.aar
