name: Build WebRTC Android AAR (M92 â€“ Optimized)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      WEBRTC_BRANCH: branch-heads/4606
      ANDROID_NDK_VERSION: r21e
      DEPOT_TOOLS_UPDATE: 0
      GCLIENT_HTTP_RETRY: 5
      GIT_HTTP_LOW_SPEED_LIMIT: 0
      GIT_HTTP_LOW_SPEED_TIME: 999999

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------------------------
      # HARD DISK CLEANUP (MOST IMPORTANT STEP)
      # -------------------------------------------------
      - name: Free maximum disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/lib/jvm
          sudo apt-get clean
          sudo apt-get autoremove -y
          df -h

      # -------------------------------------------------
      # Force all temp data to /mnt (large disk)
      # -------------------------------------------------
      - name: Prepare large temp directories
        run: |
          sudo mkdir -p /mnt/git-tmp /mnt/build
          sudo chmod -R 777 /mnt
          git config --global core.tmpdir /mnt/git-tmp

      # -------------------------------------------------
      # Python 3.8 (WebRTC M92 requirement)
      # -------------------------------------------------
      - name: Setup Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      # -------------------------------------------------
      # Minimal system deps only
      # -------------------------------------------------
      - name: Install minimal system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git curl unzip perl \
            clang-14 ninja-build pkg-config

      - name: Force clang-14
        run: |
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-14 100

      # -------------------------------------------------
      # Android NDK r21e (only thing we need)
      # -------------------------------------------------
      - name: Install Android NDK r21e
        run: |
          cd /mnt
          curl -LO https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
          unzip -q android-ndk-r21e-linux-x86_64.zip
          echo "ANDROID_NDK_HOME=/mnt/android-ndk-r21e" >> $GITHUB_ENV
          echo "/mnt/android-ndk-r21e" >> $GITHUB_PATH

      # -------------------------------------------------
      # depot_tools
      # -------------------------------------------------
      - name: Fetch depot_tools
        run: |
          cd /mnt
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "/mnt/depot_tools" >> $GITHUB_PATH

      # -------------------------------------------------
      # Fetch WebRTC M92 into /mnt (CRITICAL)
      # -------------------------------------------------
      - name: Fetch WebRTC M92
        run: |
          cd /mnt
          fetch --nohooks webrtc_android
          cd src
          git checkout $WEBRTC_BRANCH

      # -------------------------------------------------
      # Harden git (googlesource stability)
      # -------------------------------------------------
      - name: Harden git
        run: |
          git config --global http.version HTTP/1.1
          git config --global fetch.parallel 1
          git config --global pack.threads 1
          git config --global core.deltaBaseCacheLimit 2g

      # -------------------------------------------------
      # gclient sync (SERIAL, NO HISTORY)
      # -------------------------------------------------
      - name: Sync WebRTC dependencies
        run: |
          cd /mnt/src
          gclient sync \
            --force \
            --no-history \
            --with_branch_heads \
            --with_tags \
            --jobs=1 || \
          gclient sync \
            --force \
            --no-history \
            --with_branch_heads \
            --with_tags \
            --jobs=1

      # -------------------------------------------------
      # Java patch (single-line Perl, safe)
      # -------------------------------------------------
      - name: Add generateKeyFrame() to Java
        run: |
          perl -0777 -i -pe 's|(private RtpSender\\(long nativeRtpSender\\)\\s*\\{\\s*this\\.nativeRtpSender = nativeRtpSender;\\s*\\})|$1\n\n  public void generateKeyFrame() {\n    nativeGenerateKeyFrame(nativeRtpSender);\n  }\n\n  private static native void nativeGenerateKeyFrame(long nativeRtpSender);\n|s unless /generateKeyFrame\\s*\\(/' \
          /mnt/src/sdk/android/api/org/webrtc/RtpSender.java

      # -------------------------------------------------
      # JNI patch (single-line Perl)
      # -------------------------------------------------
      - name: Add JNI generateKeyFrame
        run: |
          perl -0777 -i -pe 's|(#include "sdk/android/src/jni/pc/rtp_sender_jni.h"\\n)|$1\nJNI_FUNCTION_DECLARATION(void, RtpSender_nativeGenerateKeyFrame, JNIEnv*, jclass, jlong native_rtp_sender) {\n  auto* sender = reinterpret_cast<webrtc::RtpSenderInterface*>(native_rtp_sender);\n  sender->GenerateKeyFrame();\n}\n\n|s unless /nativeGenerateKeyFrame/' \
          /mnt/src/sdk/android/src/jni/pc/rtp_sender.cc

      # -------------------------------------------------
      # Build AAR (output to /mnt)
      # -------------------------------------------------
      - name: Build WebRTC Android AAR
        run: |
          cd /mnt/src
          python3 tools_webrtc/android/build_aar.py \
            --arch armeabi-v7a \
            --output /mnt/out \
            --extra-gn-args='
              is_debug=false
              rtc_use_h264=true
              rtc_enable_protobuf=false
              use_rtti=true
              use_custom_libcxx=false
            '

      # -------------------------------------------------
      # Upload artifact
      # -------------------------------------------------
      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-m92-force-keyframe-aar
          path: /mnt/out/*.aar
